uint8_t *src = s->buffer;  /* this is the packet */

/* ... */
else if (s->looptest == PCNET_LOOPTEST_CRC ||
         !CSR_DXMTFCS(s) || size < MIN_BUF_SIZE+4) {  /* just one of these conditions need to be true */
    uint32_t fcs = ~0;              /* the accumulated checksum */
    uint8_t *p = src;

    /* go through the packet byte by byte, and keep updating the checksum */
    while (p != &src[size])         /* stop after reading up to the given size */
        CRC(fcs, *p++);             /* update fcs with the CRC checksum, also increments p */

    *(uint32_t *)p = htonl(fcs);    /* save the checksum at the end of the packet */

    size += 4;
}
